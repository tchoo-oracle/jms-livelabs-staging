# Set up Logrotate

## Introduction

This lab will guide you in setting up the logrotate utility on your host machine to periodically rotate the `usagetracker.log` generated by Java Usage Tracker.

Although the size of the Java Usage Tracker log file is small, you should consider periodically truncating, compressing, archiving, or deleting the log file. This is because the Java Usage Tracker does not check for available disk space or perform these administrative tasks on the log file as it incrementally adds records to it. 

Estimated Time: 10 minutes

### Objectives

In this lab, you will:

* Set up logrotate on Linux instances
* Set up logrotatewin on Windows instances

### Prerequisites

* Access to your host machine with management agent already setup
* Completed labs 1 to 4

## Task 1: Set up logrotate on Linux instances

1. In the **Terminal** window, make sure Logrotate is installed.

    ```
    <copy>
    sudo yum install logrotate
    </copy>
    ```

2. Create a logrotate configuration file for JMS by entering this command.

    ```
    <copy>
    sudo nano /etc/logrotate.d/jms
    </copy>
    ```

3. In the file, paste the following text.

    ```
    <copy>
    /var/log/java/usagetracker.log {
      su mgmt_agent root
      create 666 mgmt_agent root
      rotate 5
      size 20M
      notifempty
      compress
      missingok
    }
    </copy>
    ```

4. To save the file, press **CTRL+x**. Before exiting, nano will ask you if you wish to save the file: Type **y** to save and exit, type **n** to abandon your changes and exit.

## Task 2: Set up Logrotatewin on Windows instances

Logrotatewin is a Windows implementation of the Logrotate utility found in Linux platforms. The goal is to use the same command line parameters and files as the Linux version. It is not provided by JMS and you will need to install it separately.

1. Download Logrotatewin from [https://sourceforge.net/projects/logrotatewin/files/](https://sourceforge.net/projects/logrotatewin/files/)

2. Extract the downloaded zip file and run `logrotateSetup` to start the installer. In this example, we changed the install destination to `C:\Program Files\LogRotate\` 
    * ![image of logrotatewin install destination](/../images/logrotate-installation-example.png)
    * The installer will install to the path `C:\Program Files\LogRotate`
    * The executable file will be in `C:\Program Files\LogRotate\logrotate.exe`
    * The configuration file will be in `C:\Program Files\LogRotate\Content\logrotate.conf`

3. Setup logrotate for the `usagetracker.log` file.
    * The path to the `usagetracker.log` file can be determined from the Java Usage Tracker config file, which is located by default in `C:\Program Files\Java\conf\usagetracker.properties`
    * Right-click on the Java Usage Tracker config file and open with notepad to inspect it.
    * The path to the `usagetracker.log` file on your machine is identified by looking for the `com.oracle.usagetracker.logToFile` parameter in the Java Usage Tracker config file.
    * ![image of a sample usagetracker.properties file](/../images/usagetracker-properties-example.png)

     > **Note:** The path to the `usagetracker.log` file in this example is `C:\ProgramData\Oracle\Java\usagetracker.log`

4. Once you have identified the path of the `usagetracker.log` file, update `C:\Program Files\LogRotate\Content\logrotate.conf` with the correct path.
    * Login as an **Administrator** and open a Command Prompt window:
        * To check if you are currently running the Command Prompt as an Administrator, enter the following
        ```
        <copy>
        SETLOCAL
        PATH=C:\Windows\system32;%PATH%
        ECHO Administrative permissions required for installation of management agent. Detecting permissions...

        NET SESSION >nul 2>&1
        IF %ERRORLEVEL% == 0 (
          ECHO Success: Administrative permissions detected.
        ) ELSE (
          ECHO Failure: Current permissions insufficient. Please reopen the Command Prompt with administrative permissions.
        )
        </copy>
        ```

        * If permissions are insufficient, close and reopen the Command Prompt as an Administrator, and perform the check again.
    * Edit `logrotate.conf` with notepad :
        ```
        <copy>
        notepad C:\PROGRA~1\LogRotate\Content\logrotate.conf
        </copy>
        ```

    * Copy and paste the following to the bottom of the `logrotate.conf` file, then click save:

        ```
        <copy> 
        C:\ProgramData\Oracle\Java\usagetracker.log {
            rotate 5
            size 20M
            compress
            missingok
        }
        </copy>
        ```

    > **Note:** In this example the `usagetracker.log` is found at `C:\ProgramData\Oracle\Java\usagetracker.log`, please adjust for your implementation accordingly.

5. Create scheduled tasks on Windows.

    * With your Command Prompt window still open as an **Administrator**, create a `taskScheduler.xml` file for configuring the Windows Task Scheduler.

        ```
        <copy> 
        notepad C:\PROGRA~1\LogRotate\taskScheduler.xml
        </copy>
        ```

    * In the file, paste the following text:

        ```
        <copy> 
        <?xml version="1.0" encoding="UTF-16"?>
        <Task version="1.2" xmlns="http://schemas.microsoft.com/windows/2004/02/mit/task">
          <Triggers>
            <CalendarTrigger>
              <StartBoundary>2022-01-01T03:00:00</StartBoundary>
              <Enabled>true</Enabled>
              <ScheduleByDay>
                <DaysInterval>1</DaysInterval>
              </ScheduleByDay>
            </CalendarTrigger>
          </Triggers>
          <Principals>
            <Principal id="Author">
              <UserId>S-1-5-18</UserId>
              <RunLevel>HighestAvailable</RunLevel>
            </Principal>
          </Principals>
          <Settings>
            <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>
            <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>
            <StopIfGoingOnBatteries>true</StopIfGoingOnBatteries>
            <AllowHardTerminate>true</AllowHardTerminate>
            <StartWhenAvailable>false</StartWhenAvailable>
            <RunOnlyIfNetworkAvailable>false</RunOnlyIfNetworkAvailable>
            <IdleSettings>
              <StopOnIdleEnd>true</StopOnIdleEnd>
              <RestartOnIdle>false</RestartOnIdle>
            </IdleSettings>
            <AllowStartOnDemand>true</AllowStartOnDemand>
            <Enabled>true</Enabled>
            <Hidden>false</Hidden>
            <RunOnlyIfIdle>false</RunOnlyIfIdle>
            <WakeToRun>false</WakeToRun>
            <ExecutionTimeLimit>PT72H</ExecutionTimeLimit>
            <Priority>7</Priority>
          </Settings>
          <Actions Context="Author">
            <Exec>
              <Command>"C:\PROGRA~1\LogRotate\logrotate.exe"</Command>
              <Arguments>"C:\PROGRA~1\LogRotate\Content\logrotate.conf"</Arguments>
            </Exec>
          </Actions>
        </Task>
        </copy>
        ```

        Go to the File option and click the Save button to save the file. Close the notepad window.

        >**Note:** The xml configuration file contains the settings to create a daily task to run Logrotatewin at 3:00am.

    * Move to the command prompt window again, run the following commands to create a scheduled task using the XML file
        ```
        <copy>
        SETLOCAL
        PATH=C:\Windows\system32;%PATH% 
        SCHTASKS /CREATE /XML "C:\PROGRA~1\LogRotate\taskScheduler.xml" /TN "Logrotate\Default task"
        </copy>
        ```
    * This will create a daily task to run Logrotatewin at 3:00am.

## Want to Learn More?

* Refer to [How to Create a Custom Log File Rotation by logrotate](https://support.oracle.com/knowledge/Oracle%20Linux%20and%20Virtualization/2087525_1.html) for more details.

* Use the [Troubleshooting](https://docs.oracle.com/en-us/iaas/jms/doc/troubleshooting.html#GUID-2D613C72-10F3-4905-A306-4F2673FB1CD3) chapter for explanations on how to diagnose and resolve common problems encountered when installing or using Java Management Service.

* If the problem still persists or if the problem you are facing is not listed, please refer to the [Getting Help and Contacting Support](https://docs.oracle.com/en-us/iaas/Content/GSG/Tasks/contactingsupport.htm) section or you may open a a support service request using the **Help** menu in the OCI console.

## Acknowledgements

* **Author** - Teck Kian Choo, Java Management Service
